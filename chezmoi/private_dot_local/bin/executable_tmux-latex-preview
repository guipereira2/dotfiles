#!/bin/bash
TMPFILE="/tmp/copilot-latex-preview.html"
KATEX_DIR="$(npm root -g)/katex/dist"
FORMULAS_FILE="/tmp/copilot-latex.txt"

if [ ! -f "$FORMULAS_FILE" ]; then
    tmux display-message "Nenhuma fórmula LaTeX disponível"
    exit 0
fi

FORMULAS=$(python3 -c "
import html
with open('$FORMULAS_FILE') as f:
    content = f.read().strip()
parts = content.split('\n---\n')
for p in parts:
    p = p.strip()
    if p:
        e = html.escape(p)
        print(f'<span class=\"katex-render\">{e}</span><br><br>')
")

cat > "$TMPFILE" <<HEREDOC
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>LaTeX Preview</title>
<link rel="stylesheet" href="file://${KATEX_DIR}/katex.min.css">
<script src="file://${KATEX_DIR}/katex.min.js"></script>
<style>
  body {
    background: #0d1422;
    color: #e8eef8;
    font-family: 'JetBrains Mono', monospace;
    max-width: 800px;
    margin: 0 auto;
    padding: 40px 32px;
    line-height: 2.4;
    font-size: 1.4em;
  }
</style>
</head>
<body>
${FORMULAS}
<script>
document.querySelectorAll('.katex-render').forEach(el => {
  katex.render(el.textContent, el, {
    displayMode: true,
    throwOnError: false
  });
});
</script>
</body>
</html>
HEREDOC

xdg-open "$TMPFILE" 2>/dev/null &
disown
tmux display-message "LaTeX preview aberto"
